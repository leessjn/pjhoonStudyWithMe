<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Study Time Tracker</title>
    <script src="https://docs.opencv.org/4.5.2/opencv.js"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; max-width: 800px; margin: 0 auto; }
        #videoInput, #canvasOutput { max-width: 100%; display: block; margin: 10px auto; }
        button { margin: 10px; padding: 10px; }
    </style>
</head>
<body>
    <h1>Study Time Tracker</h1>
    
    <div id="timer">00:00:00</div>
    <div id="total-time">Total Study Time: 00:00:00</div>
    
    <video id="videoInput" width="640" height="480" autoplay></video>
    <canvas id="canvasOutput"></canvas>

    <div>
        <input type="text" id="username" placeholder="Enter your username">
        <button id="startBtn">Start Studying</button>
        <button id="stopBtn" disabled>Stop Studying</button>
    </div>

    <div id="rankings">
        <h2>Study Time Rankings</h2>
        <table>
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>Username</th>
                    <th>Total Study Time</th>
                </tr>
            </thead>
            <tbody id="rankingsBody"></tbody>
        </table>
    </div>

    <script>
        let videoInput, canvasOutput, videoCapture;
        let faceClassifier;
        let studyTimer;
        let totalSeconds = 0;
        let sessionSeconds = 0;
        let isStudying = false;
        let isDistracted = false;
        let distractionStartTime = 0;

        // Rankings management
        function loadRankings() {
            const rankings = JSON.parse(localStorage.getItem('studyRankings') || '[]');
            rankings.sort((a, b) => b.total_study_time - a.total_study_time);
            return rankings;
        }

        function saveRankings(rankings) {
            localStorage.setItem('studyRankings', JSON.stringify(rankings));
            displayRankings(rankings);
        }

        function displayRankings(rankings) {
            const rankingsBody = document.getElementById('rankingsBody');
            rankingsBody.innerHTML = rankings.map((rank, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td>${rank.name}</td>
                    <td>${formatTime(rank.total_study_time)}</td>
                </tr>
            `).join('');
        }

        function formatTime(totalSecs) {
            const hours = Math.floor(totalSecs / 3600);
            const minutes = Math.floor((totalSecs % 3600) / 60);
            const seconds = totalSecs % 60;
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function updateTimerDisplay() {
            document.getElementById('timer').textContent = formatTime(sessionSeconds);
            document.getElementById('total-time').textContent = `Total Study Time: ${formatTime(totalSeconds)}`;
        }

        function detectDistraction(src) {
            let gray = new cv.Mat();
            let binary = new cv.Mat();
            
            // Convert to grayscale
            cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
            
            // Binary thresholding
            cv.threshold(gray, binary, 50, 255, cv.THRESH_BINARY_INV);
            
            // Find contours
            let contours = new cv.MatVector();
            let hierarchy = new cv.Mat();
            cv.findContours(binary, contours, hierarchy, cv.RETR_EXTERNAL, cv.CHAIN_APPROX_SIMPLE);
            
            for (let i = 0; i < contours.size(); i++) {
                let contour = contours.get(i);
                let rect = cv.boundingRect(contour);
                
                // Aspect ratio and area checks similar to C++ implementation
                let aspectRatio = rect.width / rect.height;
                let area = cv.contourArea(contour);
                
                if (aspectRatio >= 0.4 && aspectRatio <= 2.5 && 
                    area > 5000 && area < 100000) {
                    
                    // Draw red rectangle for distraction
                    cv.rectangle(src, 
                        new cv.Point(rect.x, rect.y), 
                        new cv.Point(rect.x + rect.width, rect.y + rect.height), 
                        [0, 0, 255, 255], 2
                    );
                    
                    // Free memory
                    gray.delete(); binary.delete(); 
                    contours.delete(); hierarchy.delete();
                    
                    return true;
                }
            }
            
            // Free memory
            gray.delete(); binary.delete(); 
            contours.delete(); hierarchy.delete();
            
            return false;
        }

        function processVideo() {
            if (!isStudying) return;

            let username = document.getElementById('username').value || 'Anonymous';
            let src = new cv.Mat(videoInput.height, videoInput.width, cv.CV_8UC4);
            let dst = new cv.Mat(videoInput.height, videoInput.width, cv.CV_8UC4);
            
            videoCapture.read(src);
            src.copyTo(dst);

            let detectedDistraction = detectDistraction(dst);
            
            if (detectedDistraction) {
                if (!isDistracted) {
                    isDistracted = true;
                    distractionStartTime = Date.now();
                }
                
                // More than 5 seconds of distraction
                if (Date.now() - distractionStartTime > 5000) {
                    isStudying = false;
                }
            } else {
                isDistracted = false;
                sessionSeconds++;
                totalSeconds++;
            }

            // Draw canvas
            cv.imshow('canvasOutput', dst);
            
            // Update display
            updateTimerDisplay();
            
            // Free memory
            src.delete(); dst.delete();
        }

        function startStudy() {
            const username = document.getElementById('username').value || 'Anonymous';
            if (!username) {
                alert('Please enter a username');
                return;
            }

            isStudying = true;
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            
            studyTimer = setInterval(processVideo, 1000);
        }

        function stopStudy() {
            clearInterval(studyTimer);
            
            const username = document.getElementById('username').value || 'Anonymous';
            const rankings = loadRankings();
            
            const userRankIndex = rankings.findIndex(r => r.name === username);
            if (userRankIndex !== -1) {
                rankings[userRankIndex].total_study_time += totalSeconds;
            } else {
                rankings.push({ name: username, total_study_time: totalSeconds });
            }
            
            rankings.sort((a, b) => b.total_study_time - a.total_study_time);
            saveRankings(rankings);
            
            // Reset
            isStudying = false;
            sessionSeconds = 0;
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            updateTimerDisplay();
        }

        // OpenCV initialization
        function onOpenCvReady() {
            videoInput = document.getElementById('videoInput');
            canvasOutput = document.getElementById('canvasOutput');
            
            // Setup video capture
            videoCapture = new cv.VideoCapture(videoInput);
            
            document.getElementById('startBtn').onclick = startStudy;
            document.getElementById('stopBtn').onclick = stopStudy;
            
            // Load existing rankings
            displayRankings(loadRankings());
        }

        // OpenCV script loading
        function loadOpenCV() {
            let script = document.createElement('script');
            script.setAttribute('async', '');
            script.setAttribute('type', 'text/javascript');
            script.addEventListener('load', onOpenCvReady);
            script.src = 'https://docs.opencv.org/4.5.2/opencv.js';
            document.head.appendChild(script);
        }

        // Request webcam access
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                videoInput.srcObject = stream;
                loadOpenCV();
            })
            .catch(err => {
                console.error("Webcam access denied", err);
                alert("Webcam access is required");
            });
    </script>
</body>
</html>
