// Replace the detectFace function with this version:
async function detectFace(src) {
    try {
        if (!faceCascade) {
            console.log("Initializing face cascade...");
            faceCascade = new cv.CascadeClassifier();
            
            try {
                const response = await fetch('./haarcascade_frontalface_default.xml');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const buffer = await response.arrayBuffer();
                console.log("Haar cascade file loaded successfully");
                
                const result = faceCascade.load(buffer);
                console.log("Cascade loading result:", result);
                
            } catch (error) {
                console.error("Error loading haar cascade file:", error);
                showStatus("Failed to load face detection. Check console for details.");
                return false;
            }
        }

        // Create grayscale image
        let gray = new cv.Mat();
        cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
        
        // Detect faces
        let faces = new cv.RectVector();
        try {
            faceCascade.detectMultiScale(gray, faces, 1.1, 3, 0, new cv.Size(30, 30));
            console.log(`Detected ${faces.size()} faces`);
        } catch (error) {
            console.error("Face detection failed:", error);
            gray.delete();
            faces.delete();
            return false;
        }
        
        let faceDetected = faces.size() > 0;
        
        // Draw rectangles around detected faces
        if (faceDetected) {
            for (let i = 0; i < faces.size(); ++i) {
                let face = faces.get(i);
                let point1 = new cv.Point(face.x, face.y);
                let point2 = new cv.Point(face.x + face.width, face.y + face.height);
                cv.rectangle(src, point1, point2, [0, 255, 0, 255], 2);
            }
            lastFaceDetectionTime = Date.now();
        }

        // Cleanup
        gray.delete();
        faces.delete();

        return faceDetected;
    } catch (error) {
        console.error("Fatal error in face detection:", error);
        showStatus("Face detection error. Check console for details.");
        return false;
    }
}

// Also modify the processVideo function with better error handling:
async function processVideo() {
    if (!isStudying || !window.cv || frameProcessing) return;
    
    frameProcessing = true;
    let src = null;
    let dst = null;
    
    try {
        if (!videoCapture || !videoInput.videoWidth) {
            console.error("Video capture not initialized properly");
            showStatus("Video capture error. Please restart.");
            return;
        }

        src = new cv.Mat(videoInput.height, videoInput.width, cv.CV_8UC4);
        dst = new cv.Mat(videoInput.height, videoInput.width, cv.CV_8UC4);
        
        videoCapture.read(src);
        src.copyTo(dst);

        const faceDetected = await detectFace(dst);
        updateTrackingStatus(faceDetected);

        if (!faceDetected && (Date.now() - lastFaceDetectionTime > 3000)) {
            if (!isDistracted) {
                isDistracted = true;
                distractionStartTime = Date.now();
            }
            
            if (Date.now() - distractionStartTime > 5000) {
                showStatus("Face not detected. Please return to studying.", true);
            }
        } else if (faceDetected) {
            isDistracted = false;
            sessionSeconds++;
            totalSeconds++;
            showStatus("Studying...", false);
        }

        cv.imshow('canvasOutput', dst);
        
    } catch (error) {
        console.error("Video processing error:", error, "\nStack:", error.stack);
        showStatus("Error processing video. Please restart.");
    } finally {
        if (src) src.delete();
        if (dst) dst.delete();
        frameProcessing = false;
    }
}

// Add this initialization check
window.addEventListener('load', () => {
    console.log("OpenCV status:", window.cv ? "Loaded" : "Not loaded");
});
